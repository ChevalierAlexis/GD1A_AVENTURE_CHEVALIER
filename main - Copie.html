<!doctype html>
<html lang="fr">

<head>
    <link rel="shortcut icon" href="#" />
    <meta charset="UTF-8" />
    <title>Zelda-Like</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>

<body>
    <script type="text/javascript">

        class sceneExemple extends Phaser.Scene {
            constructor() {
                super("sceneExemple");
            }


            preload() {
                //images
                this.load.image('tuiles', 'assets/block.png');
                this.load.tilemapTiledJSON('map', 'map.json');
                this.load.image('sky', 'assets/sky.png');
                this.load.image('ground', 'assets/platform.png');
                this.load.image('bullet', 'assets/bullet.png');
                this.load.image('sortie', 'assets/sortie.png');
                this.load.spritesheet('perso', 'assets/Ennemisprite1.png',
                    { frameWidth: 64, frameHeight: 64 });
                this.load.spritesheet('tank', 'assets/Ennemisprite1.png',
                    { frameWidth: 64, frameHeight: 64 });

            }
            create() {
                //variables
                this.dir = "E";
                this.bullets;
                this.lastFired = 0;
                this.isDown = false;
                // importation Tiled
                //tir
                this.Bullet = new Phaser.Class({

                    Extends: Phaser.GameObjects.Image,

                    initialize:

                        function Bullet(scene) {
                            Phaser.GameObjects.Image.call(this, scene, 0, 0, 'bullet');
                            this.incX = 0;
                            this.incY = 0;
                            this.lifespan = 0;
                            this.speed = Phaser.Math.GetSpeed(400, 1);
                        },


                    fire: function (x, y) {
                        this.setActive(true);
                        this.setVisible(true);

                        this.setPosition(this.player.x, this.player.y);
                        this.angle = 3.1375 //Phaser.Math.Angle.Between(x, y, player.x, player.y);
                        if (this.dir == "O") {
                            this.angle = 0
                        }

                        if (this.dir == "E") {
                            this.angle = 3.1375
                        }

                        if (this.dir == "N") {
                            this.angle = 1, 56875
                        }

                        if (this.dir == "S") {
                            this.angle = 4, 70625
                        }

                        if (this.dir == "NO") {
                            this.angle = 0, 784375
                        }

                        if (this.dir == "NE") {
                            this.angle = 2, 353125
                        }

                        if (this.dir == "SO") {
                            this.angle = 5, 490625
                        }

                        if (this.dir == "SE") {
                            this.angle = 3, 921875
                        }

                        this.setRotation(angle);

                        this.incX = Math.cos(angle);
                        this.incY = Math.sin(angle);

                        this.lifespan = 1000;
                    },

                    // fireEnnemi: function (x, y) {
                    //     this.setActive(true);
                    //     this.setVisible(true);

                    //     this.setPosition(this.Ennemi.x, this.Ennemi.y);
                    //     this.angle = Phaser.Math.Angle.Between(x, y, player.x, player.y);

                    //     this.setRotation(angle);

                    //     this.incX = Math.cos(angle);
                    //     this.incY = Math.sin(angle);

                    //     this.lifespan = 1000;
                    // },


                    update: function (time, delta) {
                        this.lifespan -= delta;

                        this.x -= this.incX * (this.speed * delta);
                        this.y -= this.incY * (this.speed * delta);

                        if (this.lifespan <= 0) {
                            this.setActive(false);
                            this.setVisible(false);
                        }
                    }

                    });

                    this.bullets = this.add.group({
                    classType: this.Bullet,
                    maxSize: 1,
                    runChildUpdate: true
                    });

    //ennemi
                // this.Ennemi = new Phaser.Class({
                    
                //     initialize:
                //         function Ennemi(pve,sx,sy) {
                //             this.physics.add.sprite(sx,sy,'ennemi');
                //             this.anims.play('left');

                //         },
                //     // attaque: function (x, y) {
                //     //     this.bullet.fireEnnemi(this.player.x, this.player.y)
                //     // },

                //     // perdpv: function () {
                //     //     pve = pve - 5
                //     //     if (pve <= 0) {
                //     //         this.detruit()
                //     //     }
                //     // },

                //     // detruit: function () {
                //     //     this.setActive(false);
                //     //     this.setVisible(false);
                //     // },
                //     preload: function (time,delta){
                        
                //     },
                //     update: function () {
                //     }
                //     })

                
                this.add.image(400, 300, 'sky');

                this.sortie = this.physics.add.staticGroup();
                this.sortie.create(3000, 500, 'sortie');


                //plateformes
                this.platforms = this.physics.add.staticGroup();
                this.platforms.create(600, 400, 'ground');
                this.platforms.create(400, 568, 'ground').setScale(2).refreshBody();
                this.platforms.create(750, 220, 'ground');
                this.platforms.create(50, 250, 'ground');

                //ennemi
                this.ennemis = this.physics.add.group({
                    key: 'ennemi',

                });


                const carte = this.add.tilemap("map");
                const tileset = carte.addTilesetImage(
                    "block",
                    "tuiles"
                );
                const calque1 = carte.createLayer(
                    "Calque de Tuiles 1",
                    tileset
                );
                carte.getObjectLayer("Ennemis").objects.forEach((ennemis)=>{
                    const ennemiSprite = this.ennemis.create(200,3000,'tank').setOrigin(0);
                });

                

                //joueur, ennemis et cam
                this.physics.world.setBounds(0,0,6400,12800)
                this.cameras.main.setBounds(0, 0, 24524, 354354);

                this.player = this.physics.add.sprite(100, 3000, 'perso');
                this.player.setCollideWorldBounds(true);
                this.physics.add.collider(this.player, this.platforms);

                this.cameras.main.startFollow(this.player);

                this.physics.add.overlap(this.player, this.sortie, sortir, null, this);
                //this.physics.add.overlap(this.Ennemi, this.Bullet, this.Ennemi.perdpv);

                //Animations
                this.anims.create({
                    key: 'left',
                    frames: this.anims.generateFrameNumbers('perso', { start: 0, end: 1 }),
                    frameRate: 10,
                    repeat: -1
                });


                this.anims.create({
                    key: 'right',
                    frames: this.anims.generateFrameNumbers('perso', { start: 2, end: 3 }),
                    frameRate: 10,
                    repeat: -1
                });

                this.anims.create({
                    key: 'up',
                    frames: this.anims.generateFrameNumbers('perso', { start: 4, end: 5 }),
                    frameRate: 10,
                    repeat: -1
                });

                this.anims.create({
                    key: 'down',
                    frames: this.anims.generateFrameNumbers('perso', { start: 6, end: 7 }),
                    frameRate: 10,
                    repeat: -1
                });

                this.anims.create({
                    key: 'dleft',
                    frames: this.anims.generateFrameNumbers('perso', { start: 8, end: 10 }),
                    frameRate: 10,
                    repeat: -1
                });


                this.anims.create({
                    key: 'dright',
                    frames: this.anims.generateFrameNumbers('perso', { start: 11, end: 13 }),
                    frameRate: 10,
                    repeat: -1
                });

                this.anims.create({
                    key: 'dup',
                    frames: this.anims.generateFrameNumbers('perso', { start: 14, end: 16 }),
                    frameRate: 10,
                    repeat: -1
                });

                this.anims.create({
                    key: 'ddown',
                    frames: this.anims.generateFrameNumbers('perso', { start: 17, end: 19 }),
                    frameRate: 10,
                    repeat: -1
                });

                function sortir() {
                    this.scene.start("scene2");
                }

                





                //controles
                this.cursors = this.input.keyboard.createCursorKeys();

                this.speed = Phaser.Math.GetSpeed(300, 1);

                this.input.on('pointerdown', function (pointer) {

                    this.isDown = true;
                });
                this.input.on('pointerup', function (pointer) {

                    this.isDown = false;
                });
            }

            update(time, delta) {
                //mouvements
                if (this.cursors.up.isDown) {
                    this.player.setVelocityY(-200);
                    this.dir = "N";
                    this.player.anims.play('dup', true);}

                else if (this.cursors.down.isDown) {
                    this.player.setVelocityY(200);
                    this.dir = "S";
                    this.player.anims.play('ddown', true);}

                else if (this.cursors.left.isDown) {
                    this.player.setVelocityX(-200);
                    this.dir = "O";
                    this.player.anims.play('dleft', true);}

                else if (this.cursors.right.isDown) {
                    this.player.setVelocityX(200);
                    this.dir = "E";
                    this.player.anims.play('dright', true);}
                
                else {
                    this.player.setVelocityY(0);
                    this.player.setVelocityX(0);
                    console.log(this.dir)
                    if (this.dir = "O") { this.player.anims.play('left', true); }
                    if (this.dir = "E") { this.player.anims.play('right', true); }
                    if (this.dir = "S") { this.player.anims.play('down', true); }
                    if (this.dir = "N") { this.player.anims.play('up', true); }
                }
                // if (this.cursors.up.isDown) {
                //     this.player.setVelocityY(-200);
                //     console.log(this.player.body.velocity.y);
                //     this.dir = "N";
                //     this.player.anims.play('dup', true);
                //     // if (this.cursors.down.isDown) {
                //     //     this.player.setVelocityY(0);
                //     // }
                //     //else {
                //     if (this.player.body.velocity.x != 0) {
                //         this.player.setVelocityY(-150);
                //         if (this.cursors.left.isDown) {
                //             this.dir = "NO";
                //             this.player.anims.play('dleft', true);
                //         }
                //         if (this.cursors.right.isDown) {
                //             this.dir = "NE";
                //             this.player.anims.play('dright', true);
                //         }
                //     }
                //     // else {
                //     //     this.player.setVelocityY(-200);
                //     //     console.log(this.player.body.velocity.y);
                //     //     this.dir="N";
                //     //     this.player.anims.play('dup', true);
                //     // }
                //     //}
                // }
                // if (this.cursors.down.isDown) {
                //     if (this.player.body.velocity.x != 0) {
                //         this.player.setVelocityY(150);
                //         if (this.cursors.left.isDown) {
                //             this.dir = "SO";
                //             this.player.anims.play('dleft', true);
                //         }
                //         if (this.cursors.right.isDown) {
                //             this.dir = "SE";
                //             this.player.anims.play('dright', true);
                //         }
                //     } else {
                //         this.player.setVelocityY(200);
                //         this.dir = "S";
                //         this.player.anims.play('ddown', true);
                //     }
                // }

                // if (this.cursors.left.isDown) {
                //     if (this.cursors.right.isDown) {
                //         this.player.setVelocityX(0);
                //     }
                //     else {
                //         if (this.player.body.velocity.y != 0) {
                //             this.player.setVelocityX(-150);
                //         } else {
                //             this.player.setVelocityX(-200);
                //             this.dir = "O";
                //             this.player.anims.play('dleft', true);
                //         }
                //     }
                // }
                // else if (this.cursors.right.isDown) {
                //     if (this.player.body.velocity.y != 0) {
                //         this.player.setVelocityX(150);
                //     } else {
                //         this.player.setVelocityX(200);
                //         this.dir = "E";
                //         this.player.anims.play('dright', true);
                //     }
                // }
                // else //if (this.player.setVelocityX(0) && this.player.setVelocityY(0))
                // {
                //     this.player.setVelocityY(0);
                //     this.player.setVelocityX(0);
                //     if (this.dir = "O") { this.player.anims.play('left', true); }
                //     if (this.dir = "E") { this.player.anims.play('right', true); }
                //     if (this.dir = "S") { this.player.anims.play('down', true); }
                //     if (this.dir = "N") { this.player.anims.play('up', true); }
                //     if (this.dir = "SE") { this.player.anims.play('right', true); }
                //     if (this.dir = "SO") { this.player.anims.play('left', true); }
                //     if (this.dir = "NE") { this.player.anims.play('right', true); }
                //     if (this.dir = "NO") { this.player.anims.play('left', true); }
                
                //tir 2
                if (this.isDown == true && time > lastFired) {
                    this.bullet = this.bullets.get();

                    if (this.bullet) {
                        this.bullet.fire(this.player.x, this.player.y);               //rajouter pour tirer dans la direction du joueur

                        lastFired = time + 50;
                    }
                }
            }
        }

        class scene2 extends Phaser.Scene {
            constructor() {
                super("scene2");
            }
            preload() {
                this.load.spritesheet('perso2', 'assets/Tanksprite.png',
                    { frameWidth: 64, frameHeight: 64 });
            }

            create() {
                this.player = this.physics.add.sprite(100, 450, 'perso2');

                this.anims.create({
                    key: 'left',
                    frames: [{ key: 'perso', frame: 2 }],
                    frameRate: 10,
                    repeat: -1
                });


                this.anims.create({
                    key: 'right',
                    frames: [{ key: 'perso', frame: 0 }],
                    frameRate: 10,
                    repeat: -1
                });

                this.anims.create({
                    key: 'up',
                    frames: [{ key: 'perso', frame: 3 }],
                    frameRate: 10,
                    repeat: -1
                });

                this.anims.create({
                    key: 'down',
                    frames: [{ key: 'perso', frame: 1 }],
                    frameRate: 10,
                    repeat: -1
                });
            }

            update() { }
        }
        var config = {
            type: Phaser.CANVAS,
            width: 1920, height: 1080,
            pixelArt: true,
            physics: {
                default: 'arcade',
                arcade: {
                    debug: false
                }
            },

            scene: [sceneExemple, scene2],
        };
        new Phaser.Game(config);

    </script>

</body>

</html>